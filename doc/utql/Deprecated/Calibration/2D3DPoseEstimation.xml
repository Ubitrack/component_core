<?xml version="1.0" encoding="UTF-8"?>

<UTQLPatternTemplates xmlns='http://ar.in.tum.de/ubitrack/utql'
                      xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
                      xmlns:xi='http://www.w3.org/2001/XInclude'
                      xmlns:h="http://www.w3.org/1999/xhtml"
                      xsi:schemaLocation='http://ar.in.tum.de/ubitrack/utql ../../schema/utql_templates.xsd'>
        
    <Pattern name="2D3DPoseEstimation" displayName="Deprecated: 2D-3D Pose Estimation">
        <Description>
            <h:p> The component computes the 6D pose from corresponding 2D and 3D points. It first computes
 			a rough initial pose which is then refined by nonlinear optimization.
                <h:br/>
			Currently, the component has one drawback: for the first step (the initialization), the
			component assumes that the first 4 3D points lie on a plane, which in general is NOT the
			case! Therefore it is currently mostly suitable for square markers...
            </h:p>
        </Description>

        <Input>
            <Node name="Camera" displayName="Camera"/>
            <Node name="ImagePlane" displayName="Image Plane"/>
            <Node name="Body" displayName="Body"/>
            <Node name="Points" displayName="Points"/>
            <Edge name="Intrinsics" source="Camera" destination="ImagePlane" displayName="Intrinsics">
                <Predicate>type=='3x3Matrix'&amp;&amp;mode=='pull'</Predicate>
            </Edge>
            <Edge name="Input2d" source="ImagePlane" destination="Points" displayName="Input 2D">
                <Predicate>type=='2DPositionList'</Predicate>
            </Edge>
            <Edge name="Input3d" source="Body" destination="Points" displayName="Input 3D">
                <Predicate>type=='3DPositionList'</Predicate>
            </Edge>
        </Input>

        <Output>
            <Edge name="Output" source="Camera" destination="Body" displayName="Body Pose">
                <Attribute name="type" value="6DError" xsi:type="EnumAttributeReferenceType"/>
            </Edge>
        </Output>

        <Constraints>
            <Correspondence name="pointCorrespondences" minMultiplicity="4">
                <Edge edge-ref="Input2d"/>
                <Edge edge-ref="Input3d"/>
            </Correspondence>

            <TriggerGroup>
                <Edge edge-ref="Input2d"/>
                <Edge edge-ref="Input3d"/>
                <Edge edge-ref="Output"/>
            </TriggerGroup>
        </Constraints>

        <DataflowConfiguration>
            <UbitrackLib class="2D3DPoseEstimation"/>
            <Attribute name="min2d3dCorresp" xsi:type="IntAttributeReferenceType"/>
            <Attribute name="initPoseMethod" xsi:type="EnumAttributeReferenceType"/>

            <!-- remove when expansion works... -->
            <Attribute name="expansion" value="space" xsi:type="EnumAttributeReferenceType"/>
        </DataflowConfiguration>
    </Pattern>
	 
    <!-- Attribute declarations -->
    
    <GlobalNodeAttributeDeclarations>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/1/1)"/>
    </GlobalNodeAttributeDeclarations>
    
    <GlobalEdgeAttributeDeclarations>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/1)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/2)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/3)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/4)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/5)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/6)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/7)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/8)"/>
    </GlobalEdgeAttributeDeclarations>

    <GlobalDataflowAttributeDeclarations>
        <!-- Unfortunately, the xpointer used in Xinclude is currently restricted to the element scheme and absolute element indices in Xerces (and thus XMLBeans) -->
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/3/1)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/3/2)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/3/3)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/3/4)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/3/5)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/3/6)"/>
        <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/3/7)"/>

        <Attribute name="min2d3dCorresp"  min="4" default="4" xsi:type="IntAttributeDeclarationType" displayName="Minimum correspondences">
            <Description>
                <h:p>Minimum amount of 2D-3D point correspondences required for the computation of the resulting pose. A minimum of four correspondences is mathematically required but you can specify more than that to reduce the maximum uncertainty in the estimated quantity.</h:p>
            </Description>
        </Attribute>
        <Attribute name="initPoseMethod" displayName="Initial Pose Method" default="0" xsi:type="EnumAttributeDeclarationType">
            <Description>
                <p xmlns="http://www.w3.org/1999/xhtml">Method for the computation of an initial pose.
                    <h:code>Planar Homography</h:code> assumes that the first 4 3D points are coplanar and computes an initial pose based on a 2D homography.
                    <h:code>Non-Planar Projection assumes an arbitrary configuration of 3D points. Take care to avoid degenerate configurations (coplanar and/or colinear 3D points).</h:code>
                </p>
            </Description>
            <EnumValue name="0" displayName="Planar Homography"/>
            <EnumValue name="1" displayName="Non-Planar Projection"/>
        </Attribute>
    </GlobalDataflowAttributeDeclarations>
    
</UTQLPatternTemplates>
